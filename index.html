<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å ´æ‰€å½“ã¦ã‚²ãƒ¼ãƒ ï¼ˆè¤‡æ•°å•é¡Œå¯¾å¿œï¼‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 20px;
    }
    /* ã‚¿ãƒ–UI */
    .tabs {
      display: flex;
      border-bottom: 2px solid #ccc;
      margin-bottom: 15px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-bottom: none;
    }
    .tab.active {
      background: #fff;
      font-weight: bold;
      border-top: 2px solid #2c7dce;
      border-left: 2px solid #2c7dce;
      border-right: 2px solid #2c7dce;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      border: 2px solid #2c7dce;
      border-radius: 6px;
      padding: 15px;
    }
    #map, #answerMap {
      height: 400px;
      margin-top: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
    }
    #quizImage {
      max-width: 100%;
      height: auto;
      margin: 10px 0;
      display: block;
    }
    .btn {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background: #2c7dce;
      color: #fff;
      cursor: pointer;
    }
    .btn:hover {
      background: #2364a5;
    }
    #result {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>å ´æ‰€å½“ã¦ã‚²ãƒ¼ãƒ ï¼ˆè¤‡æ•°å•é¡Œå¯¾å¿œï¼‰</h1>

  <!-- ã‚¿ãƒ– -->
  <div class="tabs">
    <div class="tab active" data-tab="question">å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰</div>
    <div class="tab" data-tab="answer">è§£ç­”ãƒ¢ãƒ¼ãƒ‰</div>
  </div>

  <!-- å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰ -->
  <div id="question" class="tab-content active">
    <h2>å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰</h2>
    <input type="file" id="imageUpload" accept="image/*">
    <div id="map"></div>
    <button id="saveQuestion" class="btn">æŠ•ç¨¿ã™ã‚‹</button>
  </div>

  <!-- è§£ç­”ãƒ¢ãƒ¼ãƒ‰ -->
  <div id="answer" class="tab-content">
    <h2>è§£ç­”ãƒ¢ãƒ¼ãƒ‰</h2>
    <label for="questionList">å•é¡Œã‚’é¸æŠ: </label>
    <select id="questionList"></select>
    <img id="quizImage" src="" alt="å•é¡Œç”»åƒ">
    <div id="answerMap"></div>
    <button id="guessBtn" class="btn">Guess!</button>
    <p id="result"></p>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <script>
    let correctPolygon = null;
    let questionImage = null;
    let currentQuestionIndex = null;

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
        if(tab.dataset.tab === "answer") {
          loadQuestionList();
        }
      });
    });

    // å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰ç”¨ãƒãƒƒãƒ—
    const map = L.map('map').setView([35.6812, 139.7671], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: {
        polygon: true,
        polyline: false,
        rectangle: true,
        circle: false,
        marker: false,
        circlemarker: false
      },
      edit: {
        featureGroup: drawnItems
      }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (event) {
      drawnItems.clearLayers();
      drawnItems.addLayer(event.layer);
      correctPolygon = event.layer.toGeoJSON();
    });

    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    document.getElementById("imageUpload").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          questionImage = reader.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // æŠ•ç¨¿ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼‰
    document.getElementById("saveQuestion").addEventListener("click", () => {
      if (!questionImage || !correctPolygon) {
        alert("ç”»åƒã¨æ­£è§£ç¯„å›²ã‚’è¨­å®šã—ã¦ãã ã•ã„");
        return;
      }

      const questions = JSON.parse(localStorage.getItem("questions") || "[]");
      questions.push({
        image: questionImage,
        polygon: correctPolygon
      });
      localStorage.setItem("questions", JSON.stringify(questions));

      alert("å•é¡ŒãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
      questionImage = null;
      correctPolygon = null;
      drawnItems.clearLayers();
      document.getElementById("imageUpload").value = "";
    });

    // è§£ç­”ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒãƒƒãƒ—
    const answerMap = L.map('answerMap').setView([35.6812, 139.7671], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(answerMap);

    let guessMarker = null;
    answerMap.on("click", e => {
      if (guessMarker) answerMap.removeLayer(guessMarker);
      guessMarker = L.marker(e.latlng).addTo(answerMap);
      guessMarker.latlng = e.latlng;
    });

    // å•é¡Œãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
    function loadQuestionList() {
      const questions = JSON.parse(localStorage.getItem("questions") || "[]");
      const select = document.getElementById("questionList");
      select.innerHTML = "";

      questions.forEach((q, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = "å•é¡Œ " + (i + 1);
        select.appendChild(opt);
      });

      if (questions.length > 0) {
        select.value = 0;
        loadQuestion(0);
      } else {
        document.getElementById("quizImage").src = "";
        document.getElementById("result").textContent = "ã¾ã å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“";
      }
    }

    // é¸æŠã•ã‚ŒãŸå•é¡Œã‚’ãƒ­ãƒ¼ãƒ‰
    document.getElementById("questionList").addEventListener("change", e => {
      loadQuestion(parseInt(e.target.value));
    });

    function loadQuestion(index) {
      const questions = JSON.parse(localStorage.getItem("questions") || "[]");
      const q = questions[index];
      if (!q) return;

      currentQuestionIndex = index;
      document.getElementById("quizImage").src = q.image;
      correctPolygon = q.polygon;

      if (guessMarker) {
        answerMap.removeLayer(guessMarker);
        guessMarker = null;
      }
      document.getElementById("result").textContent = "";
    }

    // è§£ç­”ãƒã‚§ãƒƒã‚¯
    document.getElementById("guessBtn").addEventListener("click", () => {
      if (!guessMarker) {
        alert("åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦äºˆæƒ³åœ°ç‚¹ã‚’é¸ã‚“ã§ãã ã•ã„");
        return;
      }

      const questions = JSON.parse(localStorage.getItem("questions") || "[]");
      const q = questions[currentQuestionIndex];
      if (!q) {
        alert("å•é¡ŒãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return;
      }

      const point = turf.point([guessMarker.latlng.lng, guessMarker.latlng.lat]);
      const poly = q.polygon.geometry;

      let resultText = "";
      if (turf.booleanPointInPolygon(point, poly)) {
        resultText = "ğŸ‰ æ­£è§£ï¼ç¯„å›²å†…ã§ã™ã€‚100ç‚¹ï¼";
      } else {
        const centroid = turf.centroid(q.polygon);
        const distance = turf.distance(point, centroid, {units: 'kilometers'});
        const score = Math.max(0, Math.round(100 - distance * 10));
        resultText = `âŒ ãƒã‚ºãƒ¬ã€‚ä¸­å¿ƒã‹ã‚‰ã®è·é›¢: ${distance.toFixed(2)} kmã€ã‚¹ã‚³ã‚¢: ${score}`;
      }
      document.getElementById("result").textContent = resultText;
    });
  </script>
</body>
</html>
