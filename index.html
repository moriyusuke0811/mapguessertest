<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>場所当てゲーム（改良版）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: sans-serif; margin: 0; }
    #map { height: 60vh; }
    #image-preview, #quiz-image { max-width: 100%; max-height: 40vh; margin: 10px 0; }
    #controls { padding: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>場所当てゲーム（改良版）</h2>

  <div id="controls">
    <button onclick="setMode('quiz')">出題モード</button>
    <button onclick="setMode('answer')">解答モード</button>
  </div>

  <div id="quiz-panel">
    <h3>出題モード</h3>
    <input type="file" id="image-input" accept="image/*"><br>
    <img id="image-preview" class="hidden">
    <p>地図をクリックして正解範囲の中心を設定 → 半径を入力</p>
    <label>半径(m): <input type="number" id="radius-input" value="1000"></label>
  </div>

  <div id="answer-panel" class="hidden">
    <h3>解答モード</h3>
    <img id="quiz-image" class="hidden">
    <p>地図をクリックして答えを選び、Guessを押してください</p>
    <button id="guess-btn">Guess</button>
    <div id="result"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([20,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let mode = "quiz";   // "quiz" or "answer"
    let answerCircle = null;
    let userMarker = null;
    let answerData = null;

    // モード切替
    function setMode(newMode) {
      mode = newMode;
      document.getElementById("quiz-panel").classList.toggle("hidden", newMode !== "quiz");
      document.getElementById("answer-panel").classList.toggle("hidden", newMode !== "answer");
      clearMap();
      document.getElementById("result").innerHTML = "";
    }

    // 出題用画像アップロード
    document.getElementById("image-input").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          document.getElementById("image-preview").src = event.target.result;
          document.getElementById("image-preview").classList.remove("hidden");
          document.getElementById("quiz-image").src = event.target.result;
          document.getElementById("quiz-image").classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    });

    // 地図クリックイベント
    map.on('click', function(e) {
      if (mode === "quiz") {
        // 正解範囲を設定
        clearMap();
        const { lat, lng } = e.latlng;
        const radius = parseInt(document.getElementById("radius-input").value);
        answerCircle = L.circle([lat, lng], { radius: radius, color: "green" }).addTo(map);
        answerData = { lat, lng, radius };
        alert(`正解範囲を設定しました: 中心(${lat.toFixed(3)}, ${lng.toFixed(3)}), 半径 ${radius}m`);
      } else if (mode === "answer") {
        // 解答候補を置く
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker(e.latlng).addTo(map).bindPopup("あなたの解答候補").openPopup();
      }
    });

    // Guessボタン
    document.getElementById("guess-btn").addEventListener("click", function() {
      if (!answerData || !userMarker) {
        alert("正解範囲と解答を設定してください");
        return;
      }
      const userLatLng = userMarker.getLatLng();
      const distance = calcDistance(userLatLng.lat, userLatLng.lng, answerData.lat, answerData.lng);

      let score;
      if (distance <= answerData.radius) {
        score = 100; // 正解範囲内は満点
      } else if (distance <= answerData.radius * 5) {
        score = 50;
      } else if (distance <= answerData.radius * 20) {
        score = 10;
      } else {
        score = 0;
      }

      document.getElementById("result").innerHTML =
        `解答地点: ${userLatLng.lat.toFixed(3)}, ${userLatLng.lng.toFixed(3)}<br>
         正解中心から ${(distance/1000).toFixed(2)} km<br>
         スコア: ${score} 点`;
      
      // 正解範囲を再描画
      if (answerCircle) map.addLayer(answerCircle);
    });

    // 距離計算（ハバーサイン）
    function calcDistance(lat1, lng1, lat2, lng2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2 - lat1) * Math.PI/180;
      const Δλ = (lng2 - lng1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // 地図クリア
    function clearMap() {
      if (answerCircle) map.removeLayer(answerCircle);
      if (userMarker) map.removeLayer(userMarker);
      answerCircle = null;
      userMarker = null;
    }
  </script>
</body>
</html>
