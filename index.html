<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>場所当てゲーム（プロトタイプ）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
  <style>
    #map { height: 400px; margin-top: 10px; }
    #quizImage { max-width: 100%; height: auto; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>場所当てゲーム（プロトタイプ）</h1>

  <h2>出題モード</h2>
  <input type="file" id="imageUpload" accept="image/*">
  <div id="map"></div>
  <button id="saveQuestion">投稿する</button>

  <h2>解答モード</h2>
  <img id="quizImage" src="" alt="問題画像">
  <div id="answerMap" style="height:400px;"></div>
  <button id="guessBtn">Guess!</button>
  <p id="result"></p>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <script>
    let correctPolygon = null;
    let questionImage = null;

    // 出題モード用マップ
    const map = L.map('map').setView([35.6812, 139.7671], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: {
        polygon: true,
        polyline: false,
        rectangle: true,
        circle: false,
        marker: false,
        circlemarker: false
      },
      edit: {
        featureGroup: drawnItems
      }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (event) {
      drawnItems.clearLayers(); // 1つだけ
      drawnItems.addLayer(event.layer);
      correctPolygon = event.layer.toGeoJSON();
    });

    // 画像アップロード
    document.getElementById("imageUpload").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          questionImage = reader.result;
          document.getElementById("quizImage").src = questionImage;
        };
        reader.readAsDataURL(file);
      }
    });

    // 投稿
    document.getElementById("saveQuestion").addEventListener("click", () => {
      if (!questionImage || !correctPolygon) {
        alert("画像と正解範囲を設定してください");
        return;
      }
      alert("問題が保存されました！（このデモではブラウザ内のみ）");
    });

    // 解答モード
    const answerMap = L.map('answerMap').setView([35.6812, 139.7671], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(answerMap);

    let guessMarker = null;
    answerMap.on("click", e => {
      if (guessMarker) answerMap.removeLayer(guessMarker);
      guessMarker = L.marker(e.latlng).addTo(answerMap);
      guessMarker.latlng = e.latlng;
    });

    document.getElementById("guessBtn").addEventListener("click", () => {
      if (!guessMarker) {
        alert("地図をクリックして予想地点を選んでください");
        return;
      }
      if (!correctPolygon) {
        alert("まだ出題が保存されていません");
        return;
      }

      const point = turf.point([guessMarker.latlng.lng, guessMarker.latlng.lat]);
      const poly = correctPolygon.geometry;

      let resultText = "";
      if (turf.booleanPointInPolygon(point, poly)) {
        resultText = "🎉 正解！範囲内です。100点！";
      } else {
        const centroid = turf.centroid(correctPolygon);
        const distance = turf.distance(point, centroid, {units: 'kilometers'});
        const score = Math.max(0, Math.round(100 - distance * 10));
        resultText = `❌ ハズレ。中心からの距離: ${distance.toFixed(2)} km、スコア: ${score}`;
      }
      document.getElementById("result").textContent = resultText;
    });
  </script>
</body>
</html>
