<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>場所当てゲーム（プロトタイプ）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: sans-serif; margin: 0; }
    #map { height: 60vh; }
    #image-preview { max-width: 100%; max-height: 40vh; margin: 10px 0; }
    #controls { padding: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>場所当てゲーム（プロトタイプ）</h2>

  <div id="controls">
    <button onclick="setMode('quiz')">出題モード</button>
    <button onclick="setMode('answer')">解答モード</button>
  </div>

  <div id="quiz-panel">
    <h3>出題モード</h3>
    <input type="file" id="image-input" accept="image/*"><br>
    <img id="image-preview" class="hidden">
    <p>地図をクリックして正解地点を設定してください</p>
  </div>

  <div id="answer-panel" class="hidden">
    <h3>解答モード</h3>
    <img id="quiz-image" class="hidden">
    <p>地図をクリックして答えてください</p>
    <div id="result"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([20,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let mode = "quiz";  // "quiz" or "answer"
    let answerPoint = null;
    let markers = [];

    // モード切替
    function setMode(newMode) {
      mode = newMode;
      document.getElementById("quiz-panel").classList.toggle("hidden", newMode !== "quiz");
      document.getElementById("answer-panel").classList.toggle("hidden", newMode !== "answer");
      clearMarkers();
    }

    // 出題用画像アップロード
    document.getElementById("image-input").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          document.getElementById("image-preview").src = event.target.result;
          document.getElementById("image-preview").classList.remove("hidden");
          document.getElementById("quiz-image").src = event.target.result;
          document.getElementById("quiz-image").classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    });

    // 地図クリックイベント
    map.on('click', function(e) {
      clearMarkers();
      const { lat, lng } = e.latlng;
      if (mode === "quiz") {
        // 正解地点を設定
        answerPoint = { lat, lng };
        L.marker([lat, lng]).addTo(map).bindPopup("正解地点").openPopup();
        alert(`正解地点を設定しました: ${lat.toFixed(3)}, ${lng.toFixed(3)}`);
      } else if (mode === "answer" && answerPoint) {
        // 解答
        const distance = calcDistance(lat, lng, answerPoint.lat, answerPoint.lng);
        let score = 0;
        if (distance < 1000) score = 100;
        else if (distance < 10000) score = 50;
        else if (distance < 100000) score = 10;

        document.getElementById("result").innerHTML = 
          `解答地点: ${lat.toFixed(3)}, ${lng.toFixed(3)}<br>
           正解から ${(distance/1000).toFixed(2)} km<br>
           スコア: ${score} 点`;

        L.marker([lat, lng]).addTo(map).bindPopup("あなたの解答").openPopup();
        L.marker([answerPoint.lat, answerPoint.lng]).addTo(map).bindPopup("正解地点");
      } else {
        alert("まず出題モードで正解を設定してください");
      }
    });

    // 距離計算（ハバーサイン）
    function calcDistance(lat1, lng1, lat2, lng2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2 - lat1) * Math.PI/180;
      const Δλ = (lng2 - lng1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // マーカーリセット
    function clearMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }
  </script>
</body>
</html>
